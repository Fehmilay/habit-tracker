<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Habit Tracker â€“ Grind Mode</title>
<style>
  :root {
    --bg: #0a0a0a;
    --surface: #141414;
    --surface2: #1c1c1c;
    --border: #2a2a2a;
    --green: #00e676;
    --green-dim: #00e67622;
    --green-mid: #00e67644;
    --red: #ff5252;
    --text: #e0e0e0;
    --text-dim: #888;
    --radius: 10px;
    --transition: .25s cubic-bezier(.4,0,.2,1);
  }
  * { margin:0; padding:0; box-sizing:border-box; }
  body {
    font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    overflow-x: hidden;
  }
  ::selection { background: var(--green); color: #000; }
  ::-webkit-scrollbar { width:6px; height:6px; }
  ::-webkit-scrollbar-track { background: var(--surface); }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius:3px; }

  /* NAV */
  .nav {
    position: sticky; top:0; z-index:100;
    display: flex; align-items: center; justify-content: space-between;
    padding: 16px 24px;
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    backdrop-filter: blur(12px);
  }
  .nav-brand {
    font-size: 1.25rem; font-weight: 700;
    background: linear-gradient(135deg, var(--green), #69f0ae);
    -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    letter-spacing: -0.5px;
  }
  .nav-tabs { display:flex; gap:4px; }
  .nav-tab {
    padding: 8px 18px; border-radius: 8px; cursor:pointer;
    font-size: .875rem; font-weight: 500;
    background: transparent; border: 1px solid transparent;
    color: var(--text-dim); transition: var(--transition);
  }
  .nav-tab:hover { color: var(--text); background: var(--surface2); }
  .nav-tab.active {
    color: var(--green); background: var(--green-dim);
    border-color: var(--green-mid);
  }
  .month-selector {
    display:flex; align-items:center; gap:8px;
  }
  .month-selector select {
    background: var(--surface2); border:1px solid var(--border);
    color: var(--text); padding:8px 12px; border-radius:8px;
    cursor:pointer; font-size:.85rem; font-weight:600;
    transition: var(--transition);
  }
  .month-selector select:hover { border-color: var(--green); }
  .month-selector select:focus { outline:none; border-color: var(--green); }

  /* PAGE */
  .page { display:none; padding:20px; max-width:1400px; margin:0 auto; }
  .page.active { display:block; }

  /* TOP STATS */
  .top-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px,1fr));
    gap: 14px; margin-bottom: 24px;
  }
  .stat-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 20px; text-align: center;
    transition: var(--transition);
  }
  .stat-card:hover { border-color: var(--green-mid); transform: translateY(-2px); }
  .stat-card .label { font-size:.75rem; color:var(--text-dim); text-transform:uppercase; letter-spacing:1px; margin-bottom:6px; }
  .stat-card .value { font-size:1.8rem; font-weight:700; color:var(--green); }
  .stat-card .sub { font-size:.75rem; color:var(--text-dim); margin-top:4px; }

  /* PROGRESS BAR */
  .progress-wrap {
    background: var(--surface); border:1px solid var(--border);
    border-radius: var(--radius); padding:20px; margin-bottom:24px;
  }
  .progress-wrap .title { font-size:.85rem; font-weight:600; margin-bottom:10px; display:flex; justify-content:space-between; }
  .progress-bar-bg {
    width:100%; height:10px; background:var(--surface2);
    border-radius:5px; overflow:hidden;
  }
  .progress-bar-fill {
    height:100%; background: linear-gradient(90deg, #00c853, #69f0ae);
    border-radius:5px; transition: width .6s ease;
  }

  /* ADD HABIT */
  .add-habit-row {
    display:flex; gap:10px; margin-bottom:24px;
  }
  .add-habit-row input {
    flex:1; padding:12px 16px;
    background: var(--surface); border:1px solid var(--border);
    border-radius: var(--radius); color:var(--text); font-size:.9rem;
    outline:none; transition: var(--transition);
  }
  .add-habit-row input:focus { border-color: var(--green); }
  .add-habit-row input::placeholder { color:var(--text-dim); }
  .btn {
    padding:12px 22px; border-radius:var(--radius); cursor:pointer;
    font-size:.85rem; font-weight:600; border:none;
    transition: var(--transition);
  }
  .btn-green { background:var(--green); color:#000; }
  .btn-green:hover { background:#69f0ae; transform:scale(1.03); }
  .btn-red { background:transparent; color:var(--red); border:1px solid var(--red); }
  .btn-red:hover { background:var(--red); color:#fff; }
  .btn-small { padding:6px 12px; font-size:.75rem; }

  /* TABLE */
  .table-wrap {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    overflow-x: auto; margin-bottom:24px;
  }
  table { width:100%; border-collapse:collapse; min-width:700px; }
  thead th {
    padding:12px 6px; font-size:.7rem; font-weight:600;
    color:var(--text-dim); text-transform:uppercase; letter-spacing:.5px;
    border-bottom:1px solid var(--border);
    position:sticky; top:0; background:var(--surface); z-index:2;
  }
  thead th:first-child { text-align:left; padding-left:16px; min-width:160px; }
  thead th:last-child { min-width:80px; }
  tbody tr { transition: var(--transition); }
  tbody tr:hover { background: var(--surface2); }
  tbody td { padding:8px 4px; text-align:center; border-bottom:1px solid var(--border); }
  tbody td:first-child {
    text-align:left; padding-left:16px;
    font-weight:600; font-size:.85rem;
    display:flex; align-items:center; gap:8px;
    white-space:nowrap;
  }
  tbody td:last-child { font-weight:700; color:var(--green); font-size:.85rem; }

  /* CHECKBOX */
  .day-cell {
    width:26px; height:26px; margin:0 auto;
    border-radius:6px; cursor:pointer;
    background: var(--surface2); border:1px solid var(--border);
    transition: all .2s ease; position:relative;
    display:flex; align-items:center; justify-content:center;
  }
  .day-cell:hover { border-color: var(--green); transform:scale(1.15); }
  .day-cell.checked {
    background: var(--green); border-color: var(--green);
    animation: pop .3s ease;
  }
  .day-cell.checked::after {
    content:'âœ“'; color:#000; font-size:.7rem; font-weight:700;
  }
  .day-cell.disabled { opacity:.15; pointer-events:none; }
  @keyframes pop {
    0% { transform:scale(1); }
    50% { transform:scale(1.3); }
    100% { transform:scale(1); }
  }

  /* CHART */
  .chart-section {
    background: var(--surface); border:1px solid var(--border);
    border-radius: var(--radius); padding:20px; margin-bottom:24px;
  }
  .chart-section .title {
    font-size:.85rem; font-weight:600; margin-bottom:16px;
  }
  .bar-chart {
    display:flex; align-items:flex-end; gap:3px; height:140px;
    padding-bottom:24px; position:relative;
  }
  .bar-col {
    flex:1; display:flex; flex-direction:column; align-items:center;
    height:100%; justify-content:flex-end;
  }
  .bar {
    width:100%; max-width:28px; border-radius:4px 4px 0 0;
    background: linear-gradient(180deg, var(--green), #00c853);
    transition: height .5s ease; min-height:2px; position:relative;
  }
  .bar:hover { filter:brightness(1.3); }
  .bar-label {
    font-size:.55rem; color:var(--text-dim); margin-top:6px;
    transform:rotate(-45deg); white-space:nowrap;
  }

  /* INSIGHTS */
  .insights-grid {
    display:grid; grid-template-columns:repeat(auto-fit,minmax(300px,1fr));
    gap:16px; margin-bottom:24px;
  }
  .insight-card {
    background:var(--surface); border:1px solid var(--border);
    border-radius:var(--radius); padding:24px;
  }
  .insight-card .title { font-size:.85rem; font-weight:600; margin-bottom:16px; color:var(--green); }
  .insight-row {
    display:flex; justify-content:space-between; align-items:center;
    padding:10px 0; border-bottom:1px solid var(--border);
    font-size:.85rem;
  }
  .insight-row:last-child { border-bottom:none; }
  .insight-row .val { font-weight:700; color:var(--green); }
  .habit-bar-wrap { margin-bottom:12px; }
  .habit-bar-label { display:flex; justify-content:space-between; font-size:.8rem; margin-bottom:4px; }
  .habit-bar-track {
    width:100%; height:8px; background:var(--surface2);
    border-radius:4px; overflow:hidden;
  }
  .habit-bar-fill {
    height:100%; border-radius:4px;
    background: linear-gradient(90deg, #00c853, #69f0ae);
    transition: width .6s ease;
  }
  .week-grid {
    display:grid; grid-template-columns:repeat(auto-fill,minmax(60px,1fr));
    gap:6px;
  }
  .week-card {
    background:var(--surface2); border-radius:8px; padding:10px;
    text-align:center; transition:var(--transition);
  }
  .week-card.best { border:1px solid var(--green); background:var(--green-dim); }
  .week-card .wnum { font-size:.65rem; color:var(--text-dim); }
  .week-card .wscore { font-size:.95rem; font-weight:700; }

  /* DAILY SCORE CHART (Insights) */
  .line-chart-wrap { width:100%; overflow-x:auto; }
  .line-chart { height:120px; display:flex; align-items:flex-end; gap:4px; }
  .line-bar {
    flex:1; min-width:12px; max-width:24px;
    border-radius:3px 3px 0 0;
    background: linear-gradient(180deg, var(--green), #00c85388);
    transition: height .5s ease;
  }

  /* TOAST */
  .toast {
    position:fixed; bottom:24px; right:24px; z-index:999;
    background:var(--green); color:#000; padding:12px 20px;
    border-radius:var(--radius); font-size:.85rem; font-weight:600;
    transform:translateY(80px); opacity:0;
    transition: all .3s ease;
  }
  .toast.show { transform:translateY(0); opacity:1; }

  /* RESPONSIVE */
  @media(max-width:768px) {
    .nav { flex-wrap:wrap; gap:10px; padding:12px 16px; }
    .top-stats { grid-template-columns:repeat(2,1fr); }
    .page { padding:14px; }
    .add-habit-row { flex-direction:column; }
    .insights-grid { grid-template-columns:1fr; }
    thead th:first-child { min-width:110px; }
    .day-cell { width:22px; height:22px; border-radius:4px; }
    .stat-card .value { font-size:1.4rem; }
    .month-selector span { font-size:.8rem; min-width:100px; }
  }
  @media(max-width:480px) {
    .top-stats { grid-template-columns:1fr 1fr; gap:8px; }
    .stat-card { padding:14px; }
    .nav-brand { font-size:1rem; }
    .nav-tab { padding:6px 12px; font-size:.8rem; }
  }
</style>
</head>
<body>

<!-- NAV -->
<nav class="nav">
  <div class="nav-brand">âš¡ GRIND TRACKER</div>
  <div class="nav-tabs">
    <div class="nav-tab active" onclick="switchPage('tracker')">Tracker</div>
    <div class="nav-tab" onclick="switchPage('insights')">Insights</div>
  </div>
  <div class="month-selector">
    <select id="monthSelect" onchange="selectMonth()" style="min-width:140px;">
      <!-- Generated by JS -->
    </select>
    <select id="yearSelect" onchange="selectYear()" style="min-width:100px;">
      <!-- Generated by JS -->
    </select>
  </div>
</nav>

<!-- TRACKER PAGE -->
<div class="page active" id="page-tracker">
  <!-- Top Stats -->
  <div class="top-stats">
    <div class="stat-card">
      <div class="label">Monthly Completion</div>
      <div class="value" id="statMonthly">0%</div>
      <div class="sub">Gesamtfortschritt</div>
    </div>
    <div class="stat-card">
      <div class="label">Today's Score</div>
      <div class="value" id="statToday">0/0</div>
      <div class="sub" id="statTodayLabel">Habits erledigt</div>
    </div>
    <div class="stat-card">
      <div class="label">Best Streak</div>
      <div class="value" id="statStreak">0</div>
      <div class="sub">Tage in Folge</div>
    </div>
    <div class="stat-card">
      <div class="label">Active Habits</div>
      <div class="value" id="statHabits">0</div>
      <div class="sub">Gewohnheiten</div>
    </div>
  </div>

  <!-- Monthly Progress -->
  <div class="progress-wrap">
    <div class="title">
      <span>Monthly Progress</span>
      <span id="progressPct">0%</span>
    </div>
    <div class="progress-bar-bg">
      <div class="progress-bar-fill" id="progressFill" style="width:0%"></div>
    </div>
  </div>

  <!-- Add Habit -->
  <div class="add-habit-row">
    <input type="text" id="newHabitInput" placeholder="Neuen Habit hinzufÃ¼gen..." maxlength="40"
      onkeydown="if(event.key==='Enter')addHabit()">
    <button class="btn btn-green" onclick="addHabit()">+ HinzufÃ¼gen</button>
  </div>

  <!-- Habit Table -->
  <div class="table-wrap">
    <table>
      <thead id="tableHead"></thead>
      <tbody id="tableBody"></tbody>
    </table>
  </div>

  <!-- Daily Bar Chart -->
  <div class="chart-section">
    <div class="title">ðŸ“Š Daily Score Overview</div>
    <div class="bar-chart" id="barChart"></div>
  </div>
</div>

<!-- INSIGHTS PAGE -->
<div class="page" id="page-insights">
  <div class="top-stats" style="margin-bottom:24px">
    <div class="stat-card">
      <div class="label">Ã˜ Daily Score</div>
      <div class="value" id="insAvgScore">0</div>
      <div class="sub">Durchschnitt pro Tag</div>
    </div>
    <div class="stat-card">
      <div class="label">Completion Rate</div>
      <div class="value" id="insCompRate">0%</div>
      <div class="sub">Gesamte Erfolgsquote</div>
    </div>
    <div class="stat-card">
      <div class="label">Beste Woche</div>
      <div class="value" id="insBestWeek">-</div>
      <div class="sub" id="insBestWeekSub">Score</div>
    </div>
    <div class="stat-card">
      <div class="label">Perfekte Tage</div>
      <div class="value" id="insPerfect">0</div>
      <div class="sub">100% erfÃ¼llt</div>
    </div>
  </div>

  <div class="insights-grid">
    <!-- Erfolgsquote pro Habit -->
    <div class="insight-card">
      <div class="title">ðŸŽ¯ Erfolgsquote pro Habit</div>
      <div id="insHabitBars"></div>
    </div>
    <!-- Streaks -->
    <div class="insight-card">
      <div class="title">ðŸ”¥ Streaks pro Habit</div>
      <div id="insStreaks"></div>
    </div>
    <!-- Weekly Overview -->
    <div class="insight-card" style="grid-column:1/-1;">
      <div class="title">ðŸ“… Wochen-Ãœbersicht</div>
      <div class="week-grid" id="insWeeks"></div>
    </div>
    <!-- Daily Score Chart -->
    <div class="insight-card" style="grid-column:1/-1;">
      <div class="title">ðŸ“ˆ TÃ¤glicher Score-Verlauf</div>
      <div class="line-chart-wrap">
        <div class="line-chart" id="insLineChart"></div>
      </div>
    </div>
  </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<script>
// â”€â”€ State â”€â”€
const MONTH_NAMES = ['Januar','Februar','MÃ¤rz','April','Mai','Juni','Juli','August','September','Oktober','November','Dezember'];
const DEFAULT_HABITS = ['Daily Beten','Gym / Sport','-1000 kcal Defizit','Uni / Arbeit','Bewerbung'];

let currentYear, currentMonth; // 0-indexed month
let habits = [];   // [{name, id}]
let checks = {};   // { 'habitId-day': true }

// â”€â”€ Init â”€â”€
(function init() {
  const now = new Date();
  currentYear = now.getFullYear();
  currentMonth = now.getMonth();
  loadData();
  if (habits.length === 0) {
    DEFAULT_HABITS.forEach(h => habits.push({ name: h, id: uid() }));
    saveData();
  }
  renderDropdowns();
  render();
})();

function uid() { return Math.random().toString(36).substr(2, 9); }

function storageKey() { return `ht_${currentYear}_${currentMonth}`; }

function saveData() {
  localStorage.setItem('ht_habits', JSON.stringify(habits));
  localStorage.setItem(storageKey(), JSON.stringify(checks));
}

function loadData() {
  const h = localStorage.getItem('ht_habits');
  if (h) habits = JSON.parse(h);
  const c = localStorage.getItem(storageKey());
  checks = c ? JSON.parse(c) : {};
}

function changeMonth(dir) {
  currentMonth += dir;
  if (currentMonth < 0) { currentMonth = 11; currentYear--; }
  if (currentMonth > 11) { currentMonth = 0; currentYear++; }
  loadChecksForMonth();
  renderDropdowns();
  render();
}

function loadChecksForMonth() {
  const c = localStorage.getItem(storageKey());
  checks = c ? JSON.parse(c) : {};
}

function renderDropdowns() {
  // Month dropdown
  let monthHtml = '';
  MONTH_NAMES.forEach((m, idx) => {
    const selected = idx === currentMonth ? 'selected' : '';
    monthHtml += `<option value="${idx}" ${selected}>${m}</option>`;
  });
  document.getElementById('monthSelect').innerHTML = monthHtml;

  // Year dropdown (range: last 3 years to next 3 years)
  const minYear = new Date().getFullYear() - 3;
  const maxYear = new Date().getFullYear() + 3;
  let yearHtml = '';
  for (let y = minYear; y <= maxYear; y++) {
    const selected = y === currentYear ? 'selected' : '';
    yearHtml += `<option value="${y}" ${selected}>${y}</option>`;
  }
  document.getElementById('yearSelect').innerHTML = yearHtml;
}

function selectMonth() {
  currentMonth = parseInt(document.getElementById('monthSelect').value);
  loadChecksForMonth();
  render();
}

function selectYear() {
  currentYear = parseInt(document.getElementById('yearSelect').value);
  loadChecksForMonth();
  render();
}

// â”€â”€ Helpers â”€â”€
function daysInMonth(y, m) { return new Date(y, m + 1, 0).getDate(); }

function todayDay() {
  const n = new Date();
  if (n.getFullYear() === currentYear && n.getMonth() === currentMonth) return n.getDate();
  return -1;
}

function isChecked(habitId, day) { return !!checks[`${habitId}-${day}`]; }

function toggleCheck(habitId, day) {
  const key = `${habitId}-${day}`;
  checks[key] = !checks[key];
  if (!checks[key]) delete checks[key];
  saveData();
  render();
}

// â”€â”€ Habits CRUD â”€â”€
function addHabit() {
  const input = document.getElementById('newHabitInput');
  const name = input.value.trim();
  if (!name) return;
  if (habits.some(h => h.name.toLowerCase() === name.toLowerCase())) {
    showToast('Habit existiert bereits!'); return;
  }
  habits.push({ name, id: uid() });
  input.value = '';
  saveData(); render();
  showToast('âœ… Habit hinzugefÃ¼gt!');
}

function deleteHabit(id) {
  if (!confirm('Habit wirklich lÃ¶schen?')) return;
  habits = habits.filter(h => h.id !== id);
  // Remove all checks for this habit across all months
  for (let key in localStorage) {
    if (key.startsWith('ht_') && key !== 'ht_habits') {
      const data = JSON.parse(localStorage.getItem(key));
      let changed = false;
      for (let k in data) {
        if (k.startsWith(id + '-')) { delete data[k]; changed = true; }
      }
      if (changed) localStorage.setItem(key, JSON.stringify(data));
    }
  }
  loadChecksForMonth();
  saveData(); render();
  showToast('ðŸ—‘ï¸ Habit gelÃ¶scht');
}

// â”€â”€ Computing â”€â”€
function calcDailyScore(day) {
  let done = 0;
  habits.forEach(h => { if (isChecked(h.id, day)) done++; });
  return done;
}

function calcMonthlyPct() {
  const days = daysInMonth(currentYear, currentMonth);
  const td = todayDay();
  const maxDay = td > 0 ? td : days;
  let total = 0, done = 0;
  for (let d = 1; d <= maxDay; d++) {
    habits.forEach(h => {
      total++;
      if (isChecked(h.id, d)) done++;
    });
  }
  return total === 0 ? 0 : Math.round((done / total) * 100);
}

function calcStreak(habitId) {
  // Calculate current streak backwards from today / last day
  const days = daysInMonth(currentYear, currentMonth);
  const td = todayDay();
  const start = td > 0 ? td : days;
  let streak = 0;
  for (let d = start; d >= 1; d--) {
    if (isChecked(habitId, d)) streak++;
    else break;
  }
  return streak;
}

function calcBestStreak() {
  let best = 0;
  habits.forEach(h => { best = Math.max(best, calcStreak(h.id)); });
  return best;
}

// â”€â”€ Render â”€â”€
function render() {
  renderStats();
  renderTable();
  renderBarChart();
  renderInsights();
}

function renderStats() {
  const pct = calcMonthlyPct();
  document.getElementById('statMonthly').textContent = pct + '%';
  document.getElementById('progressPct').textContent = pct + '%';
  document.getElementById('progressFill').style.width = pct + '%';

  const td = todayDay();
  if (td > 0) {
    const score = calcDailyScore(td);
    document.getElementById('statToday').textContent = `${score}/${habits.length}`;
  } else {
    document.getElementById('statToday').textContent = '-';
  }

  document.getElementById('statStreak').textContent = calcBestStreak();
  document.getElementById('statHabits').textContent = habits.length;
}

function renderTable() {
  const days = daysInMonth(currentYear, currentMonth);
  const td = todayDay();

  // Head
  let headHtml = '<tr><th>Habit</th>';
  for (let d = 1; d <= days; d++) {
    const isToday = d === td;
    headHtml += `<th style="${isToday ? 'color:var(--green);' : ''}">${d}</th>`;
  }
  headHtml += '<th>Streak</th></tr>';
  document.getElementById('tableHead').innerHTML = headHtml;

  // Body
  let bodyHtml = '';
  habits.forEach(h => {
    bodyHtml += `<tr><td>
      <button class="btn btn-red btn-small" onclick="deleteHabit('${h.id}')" title="LÃ¶schen">âœ•</button>
      ${escHtml(h.name)}
    </td>`;
    for (let d = 1; d <= days; d++) {
      const checked = isChecked(h.id, d);
      bodyHtml += `<td>
        <div class="day-cell${checked ? ' checked' : ''}"
             onclick="toggleCheck('${h.id}',${d})"></div>
      </td>`;
    }
    bodyHtml += `<td>${calcStreak(h.id)} ðŸ”¥</td></tr>`;
  });

  // Daily Score Row
  bodyHtml += '<tr style="background:var(--surface2)"><td style="color:var(--green)">Daily Score</td>';
  for (let d = 1; d <= days; d++) {
    const score = calcDailyScore(d);
    const pct = habits.length ? score / habits.length : 0;
    let color = 'var(--text-dim)';
    if (pct === 1) color = 'var(--green)';
    else if (pct >= 0.5) color = '#ffd740';
    else if (pct > 0) color = '#ff9800';
    bodyHtml += `<td style="font-weight:700;font-size:.75rem;color:${score ? color : 'var(--text-dim)'}">${score || ''}</td>`;
  }
  bodyHtml += '<td></td></tr>';

  document.getElementById('tableBody').innerHTML = bodyHtml;
}

function renderBarChart() {
  const days = daysInMonth(currentYear, currentMonth);
  const td = todayDay();
  const maxDay = td > 0 ? td : days;
  let html = '';
  for (let d = 1; d <= days; d++) {
    const score = calcDailyScore(d);
    const hPct = habits.length ? (score / habits.length) * 100 : 0;
    const opacity = d > maxDay ? '0.2' : '1';
    const isToday = d === td;
    html += `<div class="bar-col" style="opacity:${opacity}">
      <div class="bar" style="height:${Math.max(hPct, 2)}%" title="Tag ${d}: ${score}/${habits.length}"></div>
      <div class="bar-label" style="${isToday ? 'color:var(--green);font-weight:700' : ''}">${d}</div>
    </div>`;
  }
  document.getElementById('barChart').innerHTML = html;
}

// â”€â”€ Insights â”€â”€
function renderInsights() {
  const days = daysInMonth(currentYear, currentMonth);
  const td = todayDay();
  const maxDay = td > 0 ? td : days;

  // Avg daily score
  let totalScore = 0;
  let perfectDays = 0;
  for (let d = 1; d <= maxDay; d++) {
    const s = calcDailyScore(d);
    totalScore += s;
    if (habits.length && s === habits.length) perfectDays++;
  }
  const avg = maxDay > 0 ? (totalScore / maxDay).toFixed(1) : 0;
  document.getElementById('insAvgScore').textContent = avg;
  document.getElementById('insPerfect').textContent = perfectDays;

  // Completion rate
  const pct = calcMonthlyPct();
  document.getElementById('insCompRate').textContent = pct + '%';

  // Per-habit success rate bars
  let barsHtml = '';
  habits.forEach(h => {
    let done = 0;
    for (let d = 1; d <= maxDay; d++) {
      if (isChecked(h.id, d)) done++;
    }
    const rate = maxDay > 0 ? Math.round((done / maxDay) * 100) : 0;
    barsHtml += `<div class="habit-bar-wrap">
      <div class="habit-bar-label"><span>${escHtml(h.name)}</span><span style="color:var(--green)">${rate}%</span></div>
      <div class="habit-bar-track"><div class="habit-bar-fill" style="width:${rate}%"></div></div>
    </div>`;
  });
  document.getElementById('insHabitBars').innerHTML = barsHtml;

  // Streaks
  let streaksHtml = '';
  habits.forEach(h => {
    const s = calcStreak(h.id);
    streaksHtml += `<div class="insight-row"><span>${escHtml(h.name)}</span><span class="val">${s} ðŸ”¥</span></div>`;
  });
  document.getElementById('insStreaks').innerHTML = streaksHtml;

  // Best week
  const weeks = [];
  for (let w = 0; w < Math.ceil(days / 7); w++) {
    let wScore = 0, wTotal = 0;
    for (let d = w * 7 + 1; d <= Math.min((w + 1) * 7, days); d++) {
      if (d > maxDay) break;
      habits.forEach(h => {
        wTotal++;
        if (isChecked(h.id, d)) wScore++;
      });
    }
    weeks.push({ num: w + 1, score: wScore, total: wTotal, pct: wTotal ? Math.round((wScore / wTotal) * 100) : 0 });
  }
  let bestWeek = weeks.reduce((a, b) => b.pct > a.pct ? b : a, { pct: -1, num: 0 });
  document.getElementById('insBestWeek').textContent = bestWeek.num > 0 ? `KW ${bestWeek.num}` : '-';
  document.getElementById('insBestWeekSub').textContent = bestWeek.num > 0 ? `${bestWeek.pct}% Erfolg` : '';

  let weeksHtml = '';
  weeks.forEach(w => {
    const isBest = w.num === bestWeek.num && bestWeek.pct > 0;
    weeksHtml += `<div class="week-card${isBest ? ' best' : ''}">
      <div class="wnum">Woche ${w.num}</div>
      <div class="wscore" style="color:${w.pct >= 80 ? 'var(--green)' : w.pct >= 50 ? '#ffd740' : 'var(--text-dim)'}">${w.pct}%</div>
    </div>`;
  });
  document.getElementById('insWeeks').innerHTML = weeksHtml;

  // Daily score line chart
  let lineHtml = '';
  for (let d = 1; d <= days; d++) {
    const score = calcDailyScore(d);
    const hPct = habits.length ? (score / habits.length) * 100 : 0;
    const opacity = d > maxDay ? '0.15' : '1';
    lineHtml += `<div class="line-bar" style="height:${Math.max(hPct, 2)}%;opacity:${opacity}" title="Tag ${d}: ${score}/${habits.length}"></div>`;
  }
  document.getElementById('insLineChart').innerHTML = lineHtml;
}

// â”€â”€ Page Switch â”€â”€
function switchPage(page) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.getElementById(`page-${page}`).classList.add('active');
  document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
  event.target.classList.add('active');
}

// â”€â”€ Toast â”€â”€
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2200);
}

// â”€â”€ Escape HTML â”€â”€
function escHtml(s) {
  const d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
}
</script>
</body>
</html>
