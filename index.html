<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Habit Tracker ‚Äì Grind Mode</title>
<style>
  :root {
    --bg:#0a0a0a; --surface:#141414; --surface2:#1c1c1c;
    --border:#2a2a2a; --green:#00e676; --green-dim:#00e67622;
    --green-mid:#00e67644; --red:#ff5252; --text:#e0e0e0;
    --text-dim:#888; --radius:10px; --transition:.25s cubic-bezier(.4,0,.2,1);
  }
  * { margin:0; padding:0; box-sizing:border-box; }
  body { font-family:'Segoe UI',system-ui,-apple-system,sans-serif; background:var(--bg); color:var(--text); min-height:100vh; overflow-x:hidden; }
  ::selection { background:var(--green); color:#000; }
  ::-webkit-scrollbar { width:6px; height:6px; }
  ::-webkit-scrollbar-track { background:var(--surface); }
  ::-webkit-scrollbar-thumb { background:var(--border); border-radius:3px; }

  .nav { position:sticky; top:0; z-index:100; display:flex; align-items:center; justify-content:space-between; padding:12px 20px; background:var(--surface); border-bottom:1px solid var(--border); backdrop-filter:blur(12px); flex-wrap:wrap; gap:8px; }
  .nav-brand { font-size:1.2rem; font-weight:700; background:linear-gradient(135deg,var(--green),#69f0ae); -webkit-background-clip:text; -webkit-text-fill-color:transparent; letter-spacing:-.5px; }
  .nav-tabs { display:flex; gap:4px; }
  .nav-tab { padding:8px 16px; border-radius:8px; cursor:pointer; font-size:.85rem; font-weight:500; background:transparent; border:1px solid transparent; color:var(--text-dim); transition:var(--transition); user-select:none; }
  .nav-tab:hover { color:var(--text); background:var(--surface2); }
  .nav-tab.active { color:var(--green); background:var(--green-dim); border-color:var(--green-mid); }
  .nav-right { display:flex; align-items:center; gap:8px; }
  .month-selector { display:flex; align-items:center; gap:6px; }
  .month-selector select { background:var(--surface2); border:1px solid var(--border); color:var(--text); padding:7px 10px; border-radius:8px; cursor:pointer; font-size:.82rem; font-weight:600; outline:none; transition:var(--transition); }
  .month-selector select:focus { border-color:var(--green); }
  .sync-dot { width:9px; height:9px; border-radius:50%; background:var(--text-dim); display:inline-block; flex-shrink:0; transition:background .4s; }
  .sync-dot.ok     { background:var(--green); box-shadow:0 0 7px var(--green); }
  .sync-dot.busy   { background:#ffd740; animation:blink .8s infinite; }
  .sync-dot.err    { background:var(--red); }
  @keyframes blink { 0%,100%{opacity:1} 50%{opacity:.25} }
  .sync-label { font-size:.72rem; color:var(--text-dim); white-space:nowrap; }

  .page { display:none; padding:18px; max-width:1400px; margin:0 auto; }
  .page.active { display:block; }

  .top-stats { display:grid; grid-template-columns:repeat(auto-fit,minmax(175px,1fr)); gap:12px; margin-bottom:20px; }
  .stat-card { background:var(--surface); border:1px solid var(--border); border-radius:var(--radius); padding:18px; text-align:center; transition:var(--transition); }
  .stat-card:hover { border-color:var(--green-mid); transform:translateY(-2px); }
  .stat-card .label { font-size:.7rem; color:var(--text-dim); text-transform:uppercase; letter-spacing:1px; margin-bottom:6px; }
  .stat-card .value { font-size:1.7rem; font-weight:700; color:var(--green); }
  .stat-card .sub   { font-size:.7rem; color:var(--text-dim); margin-top:4px; }

  .progress-wrap { background:var(--surface); border:1px solid var(--border); border-radius:var(--radius); padding:18px; margin-bottom:20px; }
  .progress-wrap .pw-title { font-size:.85rem; font-weight:600; margin-bottom:10px; display:flex; justify-content:space-between; }
  .progress-bar-bg   { width:100%; height:10px; background:var(--surface2); border-radius:5px; overflow:hidden; }
  .progress-bar-fill { height:100%; background:linear-gradient(90deg,#00c853,#69f0ae); border-radius:5px; transition:width .6s ease; }

  .add-habit-row { display:flex; gap:10px; margin-bottom:20px; }
  .add-habit-row input { flex:1; padding:11px 14px; background:var(--surface); border:1px solid var(--border); border-radius:var(--radius); color:var(--text); font-size:.9rem; outline:none; transition:var(--transition); }
  .add-habit-row input:focus { border-color:var(--green); }
  .add-habit-row input::placeholder { color:var(--text-dim); }
  .btn { padding:11px 20px; border-radius:var(--radius); cursor:pointer; font-size:.85rem; font-weight:600; border:none; transition:var(--transition); }
  .btn-green { background:var(--green); color:#000; }
  .btn-green:hover { background:#69f0ae; transform:scale(1.03); }
  .btn-red   { background:transparent; color:var(--red); border:1px solid var(--red); }
  .btn-red:hover { background:var(--red); color:#fff; }
  .btn-small { padding:5px 10px; font-size:.72rem; }
  .btn-ghost { background:var(--surface2); border:1px solid var(--border); color:var(--text-dim); }
  .btn-ghost:hover { border-color:var(--green); color:var(--green); }

  .table-wrap { background:var(--surface); border:1px solid var(--border); border-radius:var(--radius); overflow-x:auto; margin-bottom:20px; }
  table { width:100%; border-collapse:collapse; min-width:700px; }
  thead th { padding:10px 5px; font-size:.68rem; font-weight:600; color:var(--text-dim); text-transform:uppercase; letter-spacing:.5px; border-bottom:1px solid var(--border); position:sticky; top:0; background:var(--surface); z-index:2; }
  thead th:first-child { text-align:left; padding-left:14px; min-width:155px; }
  thead th:last-child  { min-width:75px; }
  tbody tr { transition:var(--transition); }
  tbody tr:hover { background:var(--surface2); }
  tbody td { padding:7px 4px; text-align:center; border-bottom:1px solid var(--border); }
  tbody td:first-child { text-align:left; padding-left:14px; font-weight:600; font-size:.82rem; display:flex; align-items:center; gap:7px; white-space:nowrap; }
  tbody td:last-child  { font-weight:700; color:var(--green); font-size:.82rem; }

  .day-cell { width:24px; height:24px; margin:0 auto; border-radius:5px; cursor:pointer; background:var(--surface2); border:1px solid var(--border); transition:all .2s ease; display:flex; align-items:center; justify-content:center; }
  .day-cell:hover   { border-color:var(--green); transform:scale(1.15); }
  .day-cell.checked { background:var(--green); border-color:var(--green); animation:pop .3s ease; }
  .day-cell.checked::after { content:'‚úì'; color:#000; font-size:.65rem; font-weight:700; }
  @keyframes pop { 0%{transform:scale(1)} 50%{transform:scale(1.35)} 100%{transform:scale(1)} }

  .chart-section { background:var(--surface); border:1px solid var(--border); border-radius:var(--radius); padding:18px; margin-bottom:20px; }
  .chart-section .cs-title { font-size:.85rem; font-weight:600; margin-bottom:14px; }
  .bar-chart { display:flex; align-items:flex-end; gap:3px; height:130px; padding-bottom:22px; }
  .bar-col   { flex:1; display:flex; flex-direction:column; align-items:center; height:100%; justify-content:flex-end; }
  .bar       { width:100%; max-width:26px; border-radius:4px 4px 0 0; background:linear-gradient(180deg,var(--green),#00c853); transition:height .5s ease; min-height:2px; }
  .bar:hover { filter:brightness(1.3); }
  .bar-label { font-size:.52rem; color:var(--text-dim); margin-top:5px; transform:rotate(-45deg); white-space:nowrap; }

  .insights-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(280px,1fr)); gap:14px; margin-bottom:20px; }
  .insight-card       { background:var(--surface); border:1px solid var(--border); border-radius:var(--radius); padding:22px; }
  .insight-card .title { font-size:.85rem; font-weight:600; margin-bottom:14px; color:var(--green); }
  .insight-row        { display:flex; justify-content:space-between; align-items:center; padding:9px 0; border-bottom:1px solid var(--border); font-size:.83rem; }
  .insight-row:last-child { border-bottom:none; }
  .insight-row .val   { font-weight:700; color:var(--green); }
  .habit-bar-wrap     { margin-bottom:11px; }
  .habit-bar-label    { display:flex; justify-content:space-between; font-size:.78rem; margin-bottom:4px; }
  .habit-bar-track    { width:100%; height:7px; background:var(--surface2); border-radius:4px; overflow:hidden; }
  .habit-bar-fill     { height:100%; border-radius:4px; background:linear-gradient(90deg,#00c853,#69f0ae); transition:width .6s ease; }
  .week-grid  { display:grid; grid-template-columns:repeat(auto-fill,minmax(58px,1fr)); gap:5px; }
  .week-card  { background:var(--surface2); border-radius:7px; padding:9px; text-align:center; }
  .week-card.best { border:1px solid var(--green); background:var(--green-dim); }
  .week-card .wnum  { font-size:.62rem; color:var(--text-dim); }
  .week-card .wscore { font-size:.9rem; font-weight:700; }
  .line-chart-wrap { width:100%; overflow-x:auto; }
  .line-chart { height:110px; display:flex; align-items:flex-end; gap:3px; }
  .line-bar   { flex:1; min-width:11px; max-width:22px; border-radius:3px 3px 0 0; background:linear-gradient(180deg,var(--green),#00c85388); transition:height .5s ease; }

  .toast { position:fixed; bottom:22px; right:22px; z-index:999; background:var(--green); color:#000; padding:11px 18px; border-radius:var(--radius); font-size:.83rem; font-weight:600; transform:translateY(80px); opacity:0; transition:all .3s ease; pointer-events:none; }
  .toast.show { transform:translateY(0); opacity:1; }

  /* MODAL */
  .modal-overlay { position:fixed; inset:0; z-index:1000; background:rgba(0,0,0,.9); backdrop-filter:blur(8px); display:flex; align-items:center; justify-content:center; padding:20px; }
  .modal-overlay.hidden { display:none; }
  .modal { background:var(--surface); border:1px solid var(--border); border-radius:16px; padding:28px; max-width:520px; width:100%; }
  .modal h2 { font-size:1.2rem; margin-bottom:6px; }
  .modal h2 span { color:var(--green); }
  .modal > p { font-size:.82rem; color:var(--text-dim); margin-bottom:18px; line-height:1.6; }
  .modal input[type=text], .modal input[type=password] {
    width:100%; padding:12px 14px; background:var(--surface2); border:1px solid var(--border);
    border-radius:var(--radius); color:var(--text); font-size:.85rem; outline:none;
    transition:var(--transition); margin-bottom:10px; font-family:monospace; letter-spacing:.5px;
  }
  .modal input:focus { border-color:var(--green); }
  .modal input::placeholder { color:var(--text-dim); font-family:inherit; letter-spacing:0; }
  .modal-actions { display:flex; gap:10px; margin-top:14px; flex-wrap:wrap; }
  .steps { background:var(--surface2); border-radius:var(--radius); padding:14px; margin-bottom:16px; }
  .steps ol { padding-left:16px; }
  .steps li { font-size:.8rem; color:var(--text-dim); margin-bottom:6px; line-height:1.5; }
  .steps li a { color:var(--green); text-decoration:none; }
  .steps li a:hover { text-decoration:underline; }
  .steps code { background:var(--bg); padding:2px 5px; border-radius:4px; font-size:.75rem; color:var(--text); }
  .steps strong { color:var(--text); }

  @media(max-width:768px) {
    .top-stats { grid-template-columns:repeat(2,1fr); }
    .page { padding:12px; }
    .add-habit-row { flex-direction:column; }
    .insights-grid { grid-template-columns:1fr; }
    thead th:first-child { min-width:100px; }
    .day-cell { width:20px; height:20px; }
    .stat-card .value { font-size:1.4rem; }
  }
  @media(max-width:480px) {
    .top-stats { grid-template-columns:1fr 1fr; gap:7px; }
    .stat-card { padding:12px; }
    .nav-brand { font-size:1rem; }
    .nav-tab { padding:6px 10px; font-size:.8rem; }
  }
</style>
</head>
<body>

<!-- NAV -->
<nav class="nav">
  <div class="nav-brand">‚ö° GRIND TRACKER</div>
  <div class="nav-tabs">
    <div class="nav-tab active" onclick="switchPage('tracker',event)">Tracker</div>
    <div class="nav-tab" onclick="switchPage('insights',event)">Insights</div>
  </div>
  <div class="nav-right">
    <div class="month-selector">
      <select id="monthSelect" onchange="selectMonth()"></select>
      <select id="yearSelect"  onchange="selectYear()"></select>
    </div>
    <span class="sync-dot" id="syncDot" title="Sync-Status"></span>
    <span class="sync-label" id="syncLabel">‚Äì</span>
    <button class="btn btn-ghost" style="padding:6px 10px;font-size:.8rem;" onclick="openSetup()">‚öôÔ∏è</button>
  </div>
</nav>

<!-- TRACKER PAGE -->
<div class="page active" id="page-tracker">
  <div class="top-stats">
    <div class="stat-card"><div class="label">Monthly Completion</div><div class="value" id="statMonthly">0%</div><div class="sub">Gesamtfortschritt</div></div>
    <div class="stat-card"><div class="label">Today's Score</div><div class="value" id="statToday">-</div><div class="sub">Habits erledigt</div></div>
    <div class="stat-card"><div class="label">Best Streak</div><div class="value" id="statStreak">0</div><div class="sub">üî• Tage in Folge</div></div>
    <div class="stat-card"><div class="label">Active Habits</div><div class="value" id="statHabits">0</div><div class="sub">Gewohnheiten</div></div>
  </div>
  <div class="progress-wrap">
    <div class="pw-title"><span>Monthly Progress</span><span id="progressPct">0%</span></div>
    <div class="progress-bar-bg"><div class="progress-bar-fill" id="progressFill" style="width:0%"></div></div>
  </div>
  <div class="add-habit-row">
    <input type="text" id="newHabitInput" placeholder="Neuen Habit hinzuf√ºgen..." maxlength="40" onkeydown="if(event.key==='Enter')addHabit()">
    <button class="btn btn-green" onclick="addHabit()">+ Hinzuf√ºgen</button>
  </div>
  <div class="table-wrap">
    <table><thead id="tableHead"></thead><tbody id="tableBody"></tbody></table>
  </div>
  <div class="chart-section">
    <div class="cs-title">üìä Daily Score Overview</div>
    <div class="bar-chart" id="barChart"></div>
  </div>
</div>

<!-- INSIGHTS PAGE -->
<div class="page" id="page-insights">
  <div class="top-stats" style="margin-bottom:20px">
    <div class="stat-card"><div class="label">√ò Daily Score</div><div class="value" id="insAvgScore">0</div><div class="sub">Durchschnitt pro Tag</div></div>
    <div class="stat-card"><div class="label">Completion Rate</div><div class="value" id="insCompRate">0%</div><div class="sub">Gesamte Erfolgsquote</div></div>
    <div class="stat-card"><div class="label">Beste Woche</div><div class="value" id="insBestWeek">-</div><div class="sub" id="insBestWeekSub">Score</div></div>
    <div class="stat-card"><div class="label">Perfekte Tage</div><div class="value" id="insPerfect">0</div><div class="sub">100% erf√ºllt</div></div>
  </div>
  <div class="insights-grid">
    <div class="insight-card"><div class="title">üéØ Erfolgsquote pro Habit</div><div id="insHabitBars"></div></div>
    <div class="insight-card"><div class="title">üî• Streaks pro Habit</div><div id="insStreaks"></div></div>
    <div class="insight-card" style="grid-column:1/-1"><div class="title">üìÖ Wochen-√úbersicht</div><div class="week-grid" id="insWeeks"></div></div>
    <div class="insight-card" style="grid-column:1/-1"><div class="title">üìà T√§glicher Score-Verlauf</div><div class="line-chart-wrap"><div class="line-chart" id="insLineChart"></div></div></div>
  </div>
</div>

<!-- SYNC SETUP MODAL -->
<div class="modal-overlay hidden" id="setupModal">
  <div class="modal">
    <h2>‚òÅÔ∏è Cloud <span>Sync Setup</span></h2>
    <p>Einmal einrichten ‚Äì dann synchronisiert sich alles automatisch auf Handy, iPad und Laptop. Kostenlos √ºber <strong style="color:var(--text)">JSONBin.io</strong>.</p>
    <div class="steps">
      <ol>
        <li>Gehe zu <a href="https://jsonbin.io" target="_blank">jsonbin.io</a> ‚Üí <strong>Sign Up</strong> (kostenlos, nur E-Mail)</li>
        <li>Nach Login: oben rechts auf deinen Avatar ‚Üí <strong>API Keys</strong></li>
        <li>Auf <strong>+ CREATE ACCESS KEY</strong> ‚Üí Name eingeben ‚Üí <strong>Create</strong></li>
        <li>Den <code>Secret Key</code> kopieren und unten einf√ºgen</li>
      </ol>
    </div>
    <input type="password" id="apiKeyInput" placeholder="$2a$10$deinSecretKeyHier..." autocomplete="off">
    <div id="binIdRow" style="display:none">
      <p style="font-size:.78rem;color:var(--text-dim);margin:6px 0 6px;">Schon eine Bin-ID? Einf√ºgen (optional ‚Äì sonst wird automatisch eine erstellt):</p>
      <input type="text" id="binIdInput" placeholder="Bin-ID (z.B. 65abc123...)">
    </div>
    <button style="background:none;border:none;color:var(--text-dim);font-size:.78rem;cursor:pointer;padding:0;margin-bottom:2px;" onclick="toggleBinRow()">+ Vorhandene Bin-ID einf√ºgen</button>
    <div class="modal-actions">
      <button class="btn btn-green" onclick="connectSync()">üîó Sync aktivieren</button>
      <button class="btn btn-ghost" onclick="useLocalOnly()">üì± Nur lokal nutzen</button>
    </div>
  </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CONSTANTS & STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const MONTH_NAMES    = ['Januar','Februar','M√§rz','April','Mai','Juni','Juli','August','September','Oktober','November','Dezember'];
const DEFAULT_HABITS = ['Daily Beten','Gym / Sport','-1000 kcal Defizit','Uni / Arbeit','Bewerbung'];
const BIN_URL        = 'https://api.jsonbin.io/v3/b';

let currentYear, currentMonth;
let habits    = [];
let allChecks = {};   // { "ht_2026_1": { "habitId-day": true } }
let apiKey    = '';
let binId     = '';
let localOnly = false;
let saveTimer = null;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
(function init() {
  const now    = new Date();
  currentYear  = now.getFullYear();
  currentMonth = now.getMonth();

  apiKey    = localStorage.getItem('jb_apikey') || '';
  binId     = localStorage.getItem('jb_binid')  || '';
  localOnly = localStorage.getItem('local_only') === '1';

  if (localOnly) {
    _loadLocal();
    setSyncStatus('err', 'Lokal');
    renderDropdowns(); render();
  } else if (apiKey) {
    setSyncStatus('busy', 'Lade...');
    loadFromCloud().then(() => { renderDropdowns(); render(); });
  } else {
    _loadLocal();
    renderDropdowns(); render();
    document.getElementById('setupModal').classList.remove('hidden');
  }
})();

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  JSONBIN CLOUD SYNC
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadFromCloud() {
  try {
    let url, res, data;
    if (binId) {
      // Load existing bin
      res  = await fetch(`${BIN_URL}/${binId}/latest`, { headers: { 'X-Master-Key': apiKey } });
      data = await res.json();
      if (!res.ok) throw new Error(data.message || res.status);
      const record = data.record;
      habits    = record.habits    || [];
      allChecks = record.allChecks || {};
      if (habits.length === 0) seedDefaults();
    } else {
      // First use: create bin
      seedDefaults();
      res  = await fetch(BIN_URL, {
        method: 'POST',
        headers: { 'Content-Type':'application/json', 'X-Master-Key': apiKey, 'X-Bin-Name': 'grind-tracker' },
        body: JSON.stringify({ habits, allChecks })
      });
      data = await res.json();
      if (!res.ok) throw new Error(data.message || res.status);
      binId = data.metadata.id;
      localStorage.setItem('jb_binid', binId);
      showToast('‚úÖ Cloud-Speicher erstellt!');
    }
    setSyncStatus('ok', 'Synced ‚úì');
  } catch(e) {
    setSyncStatus('err', 'Fehler');
    showToast('‚ö†Ô∏è Cloud-Fehler: ' + e.message);
    _loadLocal(); // fallback
  }
}

async function saveToCloud() {
  if (localOnly || !apiKey || !binId) {
    _saveLocal(); return;
  }
  setSyncStatus('busy', 'Speichert...');
  try {
    const res  = await fetch(`${BIN_URL}/${binId}`, {
      method:  'PUT',
      headers: { 'Content-Type':'application/json', 'X-Master-Key': apiKey },
      body:    JSON.stringify({ habits, allChecks })
    });
    const data = await res.json();
    if (!res.ok) throw new Error(data.message || res.status);
    setSyncStatus('ok', 'Synced ‚úì');
    _saveLocal(); // keep local backup
  } catch(e) {
    setSyncStatus('err', 'Sync-Fehler');
    showToast('‚ö†Ô∏è Konnte nicht speichern: ' + e.message);
    _saveLocal();
  }
}

// Debounced save ‚Äì groups rapid toggles into one request
function scheduleSave() {
  clearTimeout(saveTimer);
  saveTimer = setTimeout(saveToCloud, 800);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  LOCAL STORAGE FALLBACK
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function _saveLocal() {
  localStorage.setItem('ht_data', JSON.stringify({ habits, allChecks }));
}
function _loadLocal() {
  const raw = localStorage.getItem('ht_data');
  if (raw) {
    try { const d = JSON.parse(raw); habits = d.habits || []; allChecks = d.allChecks || {}; }
    catch(e) {}
  }
  if (habits.length === 0) seedDefaults();
}
function seedDefaults() {
  habits    = DEFAULT_HABITS.map(name => ({ name, id: uid() }));
  allChecks = {};
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SETUP MODAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openSetup() {
  document.getElementById('apiKeyInput').value = apiKey || '';
  document.getElementById('binIdInput').value  = binId  || '';
  document.getElementById('setupModal').classList.remove('hidden');
}

function toggleBinRow() {
  const row = document.getElementById('binIdRow');
  row.style.display = row.style.display === 'none' ? 'block' : 'none';
}

async function connectSync() {
  const key = document.getElementById('apiKeyInput').value.trim();
  const bid = document.getElementById('binIdInput').value.trim();
  if (!key) { showToast('‚ùå API Key einf√ºgen'); return; }
  apiKey = key;
  binId  = bid;
  localStorage.setItem('jb_apikey', apiKey);
  if (binId) localStorage.setItem('jb_binid', binId);
  localStorage.removeItem('local_only');
  localOnly = false;
  document.getElementById('setupModal').classList.add('hidden');
  setSyncStatus('busy', 'Verbinde...');
  await loadFromCloud();
  renderDropdowns(); render();
}

function useLocalOnly() {
  localOnly = true;
  localStorage.setItem('local_only', '1');
  document.getElementById('setupModal').classList.add('hidden');
  setSyncStatus('err', 'Lokal');
  _loadLocal(); renderDropdowns(); render();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SYNC INDICATOR
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function setSyncStatus(state, label) {
  document.getElementById('syncDot').className   = 'sync-dot ' + state;
  document.getElementById('syncLabel').textContent = label;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MONTH NAVIGATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function selectMonth() { currentMonth = parseInt(document.getElementById('monthSelect').value); renderDropdowns(); render(); }
function selectYear()  { currentYear  = parseInt(document.getElementById('yearSelect').value);  renderDropdowns(); render(); }

function renderDropdowns() {
  let mH = '';
  MONTH_NAMES.forEach((m,i) => mH += `<option value="${i}" ${i===currentMonth?'selected':''}>${m}</option>`);
  document.getElementById('monthSelect').innerHTML = mH;
  const minY = new Date().getFullYear()-3, maxY = new Date().getFullYear()+3;
  let yH = '';
  for (let y=minY; y<=maxY; y++) yH += `<option value="${y}" ${y===currentYear?'selected':''}>${y}</option>`;
  document.getElementById('yearSelect').innerHTML = yH;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CHECKS ACCESSORS  (per-month inside allChecks)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function mKey()                        { return `ht_${currentYear}_${currentMonth}`; }
function getChecks()                   { return allChecks[mKey()] || {}; }
function isChecked(hId, day)           { return !!(allChecks[mKey()]||{})[`${hId}-${day}`]; }

function toggleCheck(hId, day) {
  const k   = mKey(), ck = `${hId}-${day}`;
  if (!allChecks[k]) allChecks[k] = {};
  allChecks[k][ck] = !allChecks[k][ck];
  if (!allChecks[k][ck]) delete allChecks[k][ck];
  render();        // instant UI
  scheduleSave();  // debounced cloud save
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  HABITS CRUD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function addHabit() {
  const el   = document.getElementById('newHabitInput');
  const name = el.value.trim();
  if (!name) return;
  if (habits.some(h => h.name.toLowerCase() === name.toLowerCase()))
    { showToast('Habit existiert bereits!'); return; }
  habits.push({ name, id: uid() });
  el.value = '';
  render(); scheduleSave();
  showToast('‚úÖ Habit hinzugef√ºgt!');
}

function deleteHabit(id) {
  if (!confirm('Habit wirklich l√∂schen?')) return;
  habits = habits.filter(h => h.id !== id);
  // Remove checks for deleted habit in all months
  for (const mk in allChecks) {
    for (const ck in allChecks[mk]) {
      if (ck.startsWith(id + '-')) delete allChecks[mk][ck];
    }
  }
  render(); scheduleSave();
  showToast('üóëÔ∏è Habit gel√∂scht');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  COMPUTING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function uid()            { return Math.random().toString(36).substr(2,9); }
function daysInMonth(y,m) { return new Date(y,m+1,0).getDate(); }
function todayDay()       {
  const n = new Date();
  return (n.getFullYear()===currentYear && n.getMonth()===currentMonth) ? n.getDate() : -1;
}

function calcDailyScore(day) { return habits.reduce((s,h) => s+(isChecked(h.id,day)?1:0), 0); }

function calcMonthlyPct() {
  const days=daysInMonth(currentYear,currentMonth), td=todayDay(), max=td>0?td:days;
  let total=0, done=0;
  for (let d=1;d<=max;d++) habits.forEach(h=>{ total++; if(isChecked(h.id,d)) done++; });
  return total===0?0:Math.round((done/total)*100);
}

function calcStreak(hId) {
  const td=todayDay(), start=td>0?td:daysInMonth(currentYear,currentMonth);
  let s=0; for(let d=start;d>=1;d--){ if(isChecked(hId,d)) s++; else break; } return s;
}
function calcBestStreak() { return habits.reduce((b,h)=>Math.max(b,calcStreak(h.id)),0); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  RENDER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function render() { renderStats(); renderTable(); renderBarChart(); renderInsights(); }

function renderStats() {
  const pct=calcMonthlyPct();
  document.getElementById('statMonthly').textContent=pct+'%';
  document.getElementById('progressPct').textContent=pct+'%';
  document.getElementById('progressFill').style.width=pct+'%';
  const td=todayDay();
  document.getElementById('statToday').textContent=td>0?`${calcDailyScore(td)}/${habits.length}`:'-';
  document.getElementById('statStreak').textContent=calcBestStreak();
  document.getElementById('statHabits').textContent=habits.length;
}

function renderTable() {
  const days=daysInMonth(currentYear,currentMonth), td=todayDay();
  let h='<tr><th>Habit</th>';
  for(let d=1;d<=days;d++) h+=`<th style="${d===td?'color:var(--green);':''}">${d}</th>`;
  h+='<th>Streak</th></tr>';
  document.getElementById('tableHead').innerHTML=h;

  let b='';
  habits.forEach(ha=>{
    b+=`<tr><td><button class="btn btn-red btn-small" onclick="deleteHabit('${ha.id}')" title="L√∂schen">‚úï</button>${escHtml(ha.name)}</td>`;
    for(let d=1;d<=days;d++) b+=`<td><div class="day-cell${isChecked(ha.id,d)?' checked':''}" onclick="toggleCheck('${ha.id}',${d})"></div></td>`;
    b+=`<td>${calcStreak(ha.id)} üî•</td></tr>`;
  });
  b+='<tr style="background:var(--surface2)"><td style="color:var(--green)">Daily Score</td>';
  for(let d=1;d<=days;d++){
    const sc=calcDailyScore(d), p=habits.length?sc/habits.length:0;
    const col=p===1?'var(--green)':p>=.5?'#ffd740':p>0?'#ff9800':'var(--text-dim)';
    b+=`<td style="font-weight:700;font-size:.72rem;color:${col}">${sc||''}</td>`;
  }
  b+='<td></td></tr>';
  document.getElementById('tableBody').innerHTML=b;
}

function renderBarChart() {
  const days=daysInMonth(currentYear,currentMonth), td=todayDay(), max=td>0?td:days;
  let h='';
  for(let d=1;d<=days;d++){
    const sc=calcDailyScore(d), p=habits.length?(sc/habits.length)*100:0;
    h+=`<div class="bar-col" style="opacity:${d>max?.2:1}">
      <div class="bar" style="height:${Math.max(p,2)}%" title="Tag ${d}: ${sc}/${habits.length}"></div>
      <div class="bar-label" style="${d===td?'color:var(--green);font-weight:700':''}">${d}</div></div>`;
  }
  document.getElementById('barChart').innerHTML=h;
}

function renderInsights() {
  const days=daysInMonth(currentYear,currentMonth), td=todayDay(), max=td>0?td:days;
  let ts=0, perf=0;
  for(let d=1;d<=max;d++){ const s=calcDailyScore(d); ts+=s; if(habits.length&&s===habits.length) perf++; }
  document.getElementById('insAvgScore').textContent=max>0?(ts/max).toFixed(1):0;
  document.getElementById('insPerfect').textContent=perf;
  document.getElementById('insCompRate').textContent=calcMonthlyPct()+'%';

  let bH='';
  habits.forEach(h=>{
    let done=0; for(let d=1;d<=max;d++) if(isChecked(h.id,d)) done++;
    const r=max>0?Math.round((done/max)*100):0;
    bH+=`<div class="habit-bar-wrap"><div class="habit-bar-label"><span>${escHtml(h.name)}</span><span style="color:var(--green)">${r}%</span></div><div class="habit-bar-track"><div class="habit-bar-fill" style="width:${r}%"></div></div></div>`;
  });
  document.getElementById('insHabitBars').innerHTML=bH;

  let sH='';
  habits.forEach(h=>sH+=`<div class="insight-row"><span>${escHtml(h.name)}</span><span class="val">${calcStreak(h.id)} üî•</span></div>`);
  document.getElementById('insStreaks').innerHTML=sH;

  const weeks=[];
  for(let w=0;w<Math.ceil(days/7);w++){
    let ws=0,wt=0;
    for(let d=w*7+1;d<=Math.min((w+1)*7,days);d++){
      if(d>max) break;
      habits.forEach(h=>{ wt++; if(isChecked(h.id,d)) ws++; });
    }
    weeks.push({num:w+1,pct:wt?Math.round((ws/wt)*100):0});
  }
  const best=weeks.reduce((a,b)=>b.pct>a.pct?b:a,{pct:-1,num:0});
  document.getElementById('insBestWeek').textContent=best.num>0?`KW ${best.num}`:'-';
  document.getElementById('insBestWeekSub').textContent=best.num>0?`${best.pct}% Erfolg`:'';

  let wH='';
  weeks.forEach(w=>{
    const ib=w.num===best.num&&best.pct>0;
    wH+=`<div class="week-card${ib?' best':''}"><div class="wnum">Woche ${w.num}</div><div class="wscore" style="color:${w.pct>=80?'var(--green)':w.pct>=50?'#ffd740':'var(--text-dim)'}">${w.pct}%</div></div>`;
  });
  document.getElementById('insWeeks').innerHTML=wH;

  let lH='';
  for(let d=1;d<=days;d++){
    const sc=calcDailyScore(d),p=habits.length?(sc/habits.length)*100:0;
    lH+=`<div class="line-bar" style="height:${Math.max(p,2)}%;opacity:${d>max?.15:1}" title="Tag ${d}: ${sc}/${habits.length}"></div>`;
  }
  document.getElementById('insLineChart').innerHTML=lH;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  UTILITIES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function switchPage(page, e) {
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.getElementById(`page-${page}`).classList.add('active');
  document.querySelectorAll('.nav-tab').forEach(t=>t.classList.remove('active'));
  if(e&&e.target) e.target.classList.add('active');
}

function showToast(msg) {
  const t=document.getElementById('toast');
  t.textContent=msg; t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),2500);
}

function escHtml(s) { const d=document.createElement('div'); d.textContent=s; return d.innerHTML; }
</script>
</body>
</html>
